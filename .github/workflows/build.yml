name: Build macMule

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      emule_version:
        description: 'eMule version (e.g. 0.70b). Empty = oldest missing.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15-intel
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve version
        id: version
        run: |
          if [ -n "${{ inputs.emule_version }}" ]; then
            VER="${{ inputs.emule_version }}"
            PRERELEASE=$(gh release view "eMule_v${VER}-community" --repo irwir/eMule \
              --json isPrerelease --jq '.isPrerelease')
          else
            # Get all upstream releases
            UPSTREAM=$(gh release list --repo irwir/eMule --json tagName,isPrerelease --limit 50)
            # Get all macMule releases
            OURS=$(gh release list --repo "$GITHUB_REPOSITORY" --json tagName --jq '.[].tagName' --limit 50)

            # Find oldest missing version (list is newest→oldest, last match = oldest)
            MISSING_VER=""
            MISSING_PRERELEASE=""
            for row in $(echo "$UPSTREAM" | jq -c '.[] | select(.tagName | endswith("-community"))'); do
              TAG=$(echo "$row" | jq -r '.tagName')
              VER=$(echo "$TAG" | sed 's/.*_v\(.*\)-community/\1/')
              PRE=$(echo "$row" | jq -r '.isPrerelease')

              # Skip versions without x64 builds (pre-0.60a only had 32-bit)
              HAS_X64=$(gh release view "$TAG" --repo irwir/eMule --json assets \
                --jq '[.assets[].name | select(test("x64.*\\.zip$"))] | length')
              if [ "$HAS_X64" = "0" ]; then
                continue
              fi

              if ! echo "$OURS" | grep -q "^v${VER}$"; then
                MISSING_VER="$VER"
                MISSING_PRERELEASE="$PRE"
              fi
            done

            if [ -z "$MISSING_VER" ]; then
              echo "All upstream versions already have macMule releases — nothing to do."
              echo "version=" >> "$GITHUB_OUTPUT"
              echo "prerelease=" >> "$GITHUB_OUTPUT"
              echo "skip=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            VER="$MISSING_VER"
            PRERELEASE="$MISSING_PRERELEASE"
          fi
          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "prerelease=$PRERELEASE" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "Resolved eMule version: $VER (prerelease: $PRERELEASE)"

      - name: Check if already released
        if: steps.version.outputs.skip != 'true'
        id: check
        run: |
          VER="${{ steps.version.outputs.version }}"
          if gh release view "v$VER" --repo "$GITHUB_REPOSITORY" &>/dev/null; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Release v$VER already exists — skipping build."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "No release v$VER found — proceeding with build."
          fi

      - name: Install Wine Crossover
        if: steps.version.outputs.skip != 'true' && steps.check.outputs.skip == 'false'
        run: brew install --cask --no-quarantine gcenx/wine/wine-crossover

      - name: Build .dmg
        if: steps.version.outputs.skip != 'true' && steps.check.outputs.skip == 'false'
        run: ./build.sh "${{ steps.version.outputs.version }}"

      - name: Create release
        if: steps.version.outputs.skip != 'true' && steps.check.outputs.skip == 'false'
        run: |
          VER="${{ steps.version.outputs.version }}"
          PRERELEASE_FLAG=""
          if [ "${{ steps.version.outputs.prerelease }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi
          gh release create "v$VER" "build/macMule-v${VER}.dmg" \
            --title "macMule v$VER community" \
            --notes "eMule v$VER community for macOS. Download, drag to Applications, run." \
            $PRERELEASE_FLAG
